<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="author" content="å‘¨æ€¡">
  
  <meta name="description" content="Guava Cacheä½¿ç”¨æ€»ç»“">
  
  
  <meta name="keywords" content="guava, cache,, cache,, ç¼“å­˜">
  

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Guava Cacheä½¿ç”¨æ€»ç»“"/>
<meta name="twitter:description" content="Guava Cacheä½¿ç”¨æ€»ç»“"/>

  <meta property="og:title" content="Guava Cacheä½¿ç”¨æ€»ç»“" />
<meta property="og:description" content="Guava Cacheä½¿ç”¨æ€»ç»“" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.zhouyi.tech/archives/guava-cache%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" />
<meta property="article:published_time" content="2020-08-17T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-08-17T00:00:00+00:00" /><meta property="og:site_name" content="æŠ€æœ¯å­¦ä¹ ä¹‹è·¯" />


  



  
  <base href="https://www.zhouyi.tech/archives/guava-cache%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/">
  
  <title>
  Guava Cacheä½¿ç”¨æ€»ç»“ Â· æŠ€æœ¯å­¦ä¹ ä¹‹è·¯
</title>

  
  <link rel="canonical" href="https://www.zhouyi.tech/archives/guava-cache%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/">
  

  <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
    integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

  
  
  
  <link rel="stylesheet" href="https://www.zhouyi.tech/css/coder.min.4aab773750c0433c68c0e2280201a35fa394baf9ef7016cf8f8ae4ba96e597dc.css" integrity="sha256-Sqt3N1DAQzxowOIoAgGjX6OUuvnvcBbPj4rkupbll9w="
    crossorigin="anonymous" media="screen" />
  

  

  
  
  
  
  <link rel="stylesheet" href="https://www.zhouyi.tech/css/coder-dark.min.83a2010dac9f59f943b3004cd6c4f230507ad036da635d3621401d42ec4e2835.css" integrity="sha256-g6IBDayfWflDswBM1sTyMFB60DbaY102IUAdQuxOKDU="
    crossorigin="anonymous" media="screen" />
  
  

  
  <link rel="stylesheet" href="https://www.zhouyi.tech/css/main.css" />
  

  
  <script src="https://www.zhouyi.tech/js/lazysizes.min.js" async></script>
  
  <script src="https://www.zhouyi.tech/js/flying-pages.min.js" async></script>
  

  <link rel="icon" type="image/png" href="https://www.zhouyi.tech/images/f/favicon-32x32.png"
    sizes="32x32">
  <link rel="icon" type="image/png" href="https://www.zhouyi.tech/images/f/favicon-16x16.png"
    sizes="16x16">

  <link rel="amphtml" type="text/html" href="https://www.zhouyi.tech/amp/archives/guava-cache%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" title="æŠ€æœ¯å­¦ä¹ ä¹‹è·¯" />
  <meta name="generator" content="Hugo 0.75.1" />

  <meta name="baidu-site-verification" content="TiReu51WyJ" />

  
  
  <link rel="stylesheet" href="https://www.zhouyi.tech/scss/tagcloud.css" media="screen" />

</head>






<body class="colorscheme-auto">
  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://www.zhouyi.tech/">
      æŠ€æœ¯å­¦ä¹ ä¹‹è·¯
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://www.zhouyi.tech/archives/">æŠ€æœ¯</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://www.zhouyi.tech/about/">å…³äº</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


    <div class="content">
      
  <section class="container page">
  <article>
    <header>
      <h1>Guava Cacheä½¿ç”¨æ€»ç»“</h1>
    </header>

    <p>ç¼“å­˜åˆ†ä¸ºæœ¬åœ°ç¼“å­˜å’Œè¿œç«¯ç¼“å­˜ã€‚å¸¸è§çš„è¿œç«¯ç¼“å­˜æœ‰Redisï¼ŒMongoDBï¼›æœ¬åœ°ç¼“å­˜ä¸€èˆ¬ä½¿ç”¨mapçš„æ–¹å¼ä¿å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­ã€‚ä¸€èˆ¬æˆ‘ä»¬åœ¨ä¸šåŠ¡ä¸­æ“ä½œç¼“å­˜ï¼Œéƒ½ä¼šæ“ä½œç¼“å­˜å’Œæ•°æ®æºä¸¤éƒ¨åˆ†ã€‚å¦‚ï¼šputæ•°æ®æ—¶ï¼Œå…ˆæ’å…¥DBï¼Œå†åˆ é™¤åŸæ¥çš„ç¼“å­˜ï¼›geæ•°æ®æ—¶ï¼Œå…ˆæŸ¥ç¼“å­˜ï¼Œå‘½ä¸­åˆ™è¿”å›ï¼Œæ²¡æœ‰å‘½ä¸­æ—¶ï¼Œéœ€è¦æŸ¥è¯¢DBï¼Œå†æŠŠæŸ¥è¯¢ç»“æœæ”¾å…¥ç¼“å­˜ä¸­ ã€‚å¦‚æœè®¿é—®é‡å¤§ï¼Œæˆ‘ä»¬è¿˜å¾—å…¼é¡¾æœ¬åœ°ç¼“å­˜çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å¿…è¦çš„æ—¶å€™ä¹Ÿè¦è€ƒè™‘ç¼“å­˜çš„å›æ”¶ç­–ç•¥ã€‚</p>
<p>ä»Šå¤©è¯´çš„ Guava Cache æ˜¯google guavaä¸­çš„ä¸€ä¸ªå†…å­˜ç¼“å­˜æ¨¡å—ï¼Œç”¨äºå°†æ•°æ®ç¼“å­˜åˆ°JVMå†…å­˜ä¸­ã€‚ä»–å¾ˆå¥½çš„è§£å†³äº†ä¸Šé¢æåˆ°çš„å‡ ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>å¾ˆå¥½çš„å°è£…äº†getã€putæ“ä½œï¼Œèƒ½å¤Ÿé›†æˆæ•°æ®æº ï¼›</li>
<li>çº¿ç¨‹å®‰å…¨çš„ç¼“å­˜ï¼Œä¸ConcurrentMapç›¸ä¼¼ï¼Œä½†å‰è€…å¢åŠ äº†æ›´å¤šçš„å…ƒç´ å¤±æ•ˆç­–ç•¥ï¼Œåè€…åªèƒ½æ˜¾ç¤ºçš„ç§»é™¤å…ƒç´ ï¼›</li>
<li>Guava Cacheæä¾›äº†ä¸‰ç§åŸºæœ¬çš„ç¼“å­˜å›æ”¶æ–¹å¼ï¼šåŸºäºå®¹é‡å›æ”¶ã€å®šæ—¶å›æ”¶å’ŒåŸºäºå¼•ç”¨å›æ”¶ã€‚å®šæ—¶å›æ”¶æœ‰ä¸¤ç§ï¼šæŒ‰ç…§å†™å…¥æ—¶é—´ï¼Œæœ€æ—©å†™å…¥çš„æœ€å…ˆå›æ”¶ï¼›æŒ‰ç…§è®¿é—®æ—¶é—´ï¼Œæœ€æ—©è®¿é—®çš„æœ€æ—©å›æ”¶ï¼›</li>
<li>ç›‘æ§ç¼“å­˜åŠ è½½/å‘½ä¸­æƒ…å†µ</li>
</ul>
<p>Guava Cacheçš„æ¶æ„è®¾è®¡çµæ„ŸConcurrentHashMapï¼Œåœ¨ç®€å•åœºæ™¯ä¸­å¯ä»¥é€šè¿‡HashMapå®ç°ç®€å•æ•°æ®ç¼“å­˜ï¼Œä½†å¦‚æœè¦å®ç°ç¼“å­˜éšæ—¶é—´æ”¹å˜ã€å­˜å‚¨çš„æ•°æ®ç©ºé—´å¯æ§åˆ™ç¼“å­˜å·¥å…·è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚Cacheå­˜å‚¨çš„æ˜¯é”®å€¼å¯¹çš„é›†åˆï¼Œä¸åŒæ—¶æ˜¯è¿˜éœ€è¦å¤„ç†ç¼“å­˜è¿‡æœŸã€åŠ¨æ€åŠ è½½ç­‰ç®—æ³•é€»è¾‘ï¼Œéœ€è¦é¢å¤–ä¿¡æ¯å®ç°è¿™äº›æ“ä½œï¼Œå¯¹æ­¤æ ¹æ®é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œè¿˜éœ€è¦åšæ–¹æ³•ä¸æ•°æ®çš„å…³è”æ€§å°è£…ï¼Œä¸»è¦å®ç°çš„ç¼“å­˜åŠŸèƒ½æœ‰ï¼šè‡ªåŠ¨å°†èŠ‚ç‚¹åŠ è½½è‡³ç¼“å­˜ç»“æ„ä¸­ï¼Œå½“ç¼“å­˜çš„æ•°æ®è¶…è¿‡æœ€å¤§å€¼æ—¶ï¼Œä½¿ç”¨LRUç®—æ³•æ›¿æ¢ï¼›å®ƒå…·å¤‡æ ¹æ®èŠ‚ç‚¹ä¸Šä¸€æ¬¡è¢«è®¿é—®æˆ–å†™å…¥æ—¶é—´è®¡ç®—ç¼“å­˜è¿‡æœŸæœºåˆ¶ï¼Œç¼“å­˜çš„keyè¢«å°è£…åœ¨WeakReferenceå¼•ç”¨ä¸­ï¼Œç¼“å­˜çš„valueè¢«å°è£…åœ¨WeakReferenceæˆ–SoftReferenceå¼•ç”¨ä¸­ï¼›è¿˜å¯ä»¥ç»Ÿè®¡ç¼“å­˜ä½¿ç”¨è¿‡ç¨‹ä¸­çš„å‘½ä¸­ç‡ã€å¼‚å¸¸ç‡å’Œå‘½ä¸­ç‡ç­‰ç»Ÿè®¡æ•°æ®ã€‚</p>
<h4 id="æ„å»ºç¼“å­˜å¯¹è±¡">æ„å»ºç¼“å­˜å¯¹è±¡</h4>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç¤ºä¾‹ï¼Œå†æ¥è®²è§£ä½¿ç”¨æ–¹å¼ï¼š</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">package</span> com.rickiyang.learn.cache;

<span style="color:#fff;font-weight:bold">import</span> com.google.common.cache.CacheBuilder;
<span style="color:#fff;font-weight:bold">import</span> com.google.common.cache.CacheLoader;
<span style="color:#fff;font-weight:bold">import</span> com.google.common.cache.LoadingCache;

<span style="color:#fff;font-weight:bold">import</span> java.text.SimpleDateFormat;
<span style="color:#fff;font-weight:bold">import</span> java.util.Date;
<span style="color:#fff;font-weight:bold">import</span> java.util.Random;
<span style="color:#fff;font-weight:bold">import</span> java.util.concurrent.TimeUnit;

<span style="color:#007f7f">/**
</span><span style="color:#007f7f"> * @author: rickiyang
</span><span style="color:#007f7f"> * @date: 2019/6/12
</span><span style="color:#007f7f"> * @description:
</span><span style="color:#007f7f"> */</span>
<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> GuavaCacheService {

    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setCache() {
        LoadingCache&lt;Integer, String&gt; cache = CacheBuilder.<span style="color:#007f7f">newBuilder</span>()
                <span style="color:#007f7f">//è®¾ç½®å¹¶å‘çº§åˆ«ä¸º8ï¼Œå¹¶å‘çº§åˆ«æ˜¯æŒ‡å¯ä»¥åŒæ—¶å†™ç¼“å­˜çš„çº¿ç¨‹æ•°
</span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">concurrencyLevel</span>(8)
                <span style="color:#007f7f">//è®¾ç½®ç¼“å­˜å®¹å™¨çš„åˆå§‹å®¹é‡ä¸º10
</span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">initialCapacity</span>(10)
                <span style="color:#007f7f">//è®¾ç½®ç¼“å­˜æœ€å¤§å®¹é‡ä¸º100ï¼Œè¶…è¿‡100ä¹‹åå°±ä¼šæŒ‰ç…§LRUæœ€è¿‘è™½å°‘ä½¿ç”¨ç®—æ³•æ¥ç§»é™¤ç¼“å­˜é¡¹
</span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">maximumSize</span>(100)
                <span style="color:#007f7f">//æ˜¯å¦éœ€è¦ç»Ÿè®¡ç¼“å­˜æƒ…å†µ,è¯¥æ“ä½œæ¶ˆè€—ä¸€å®šçš„æ€§èƒ½,ç”Ÿäº§ç¯å¢ƒåº”è¯¥å»é™¤
</span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">recordStats</span>()
                <span style="color:#007f7f">//è®¾ç½®å†™ç¼“å­˜ånç§’é’Ÿè¿‡æœŸ
</span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">expireAfterWrite</span>(60, TimeUnit.<span style="color:#007f7f">SECONDS</span>)
                <span style="color:#007f7f">//è®¾ç½®è¯»å†™ç¼“å­˜ånç§’é’Ÿè¿‡æœŸ,å®é™…å¾ˆå°‘ç”¨åˆ°,ç±»ä¼¼äºexpireAfterWrite
</span><span style="color:#007f7f"></span>                <span style="color:#007f7f">//.expireAfterAccess(17, TimeUnit.SECONDS)
</span><span style="color:#007f7f"></span>                <span style="color:#007f7f">//åªé˜»å¡å½“å‰æ•°æ®åŠ è½½çº¿ç¨‹ï¼Œå…¶ä»–çº¿ç¨‹è¿”å›æ—§å€¼
</span><span style="color:#007f7f"></span>                <span style="color:#007f7f">//.refreshAfterWrite(13, TimeUnit.SECONDS)
</span><span style="color:#007f7f"></span>                <span style="color:#007f7f">//è®¾ç½®ç¼“å­˜çš„ç§»é™¤é€šçŸ¥
</span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">removalListener</span>(notification -&gt; {
                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(notification.<span style="color:#007f7f">getKey</span>() + <span style="color:#0ff;font-weight:bold">&#34; &#34;</span> + notification.<span style="color:#007f7f">getValue</span>() + <span style="color:#0ff;font-weight:bold">&#34; è¢«ç§»é™¤,åŸå› :&#34;</span> + notification.<span style="color:#007f7f">getCause</span>());
                })
                <span style="color:#007f7f">//buildæ–¹æ³•ä¸­å¯ä»¥æŒ‡å®šCacheLoaderï¼Œåœ¨ç¼“å­˜ä¸å­˜åœ¨æ—¶é€šè¿‡CacheLoaderçš„å®ç°è‡ªåŠ¨åŠ è½½ç¼“å­˜
</span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">build</span>(<span style="color:#fff;font-weight:bold">new</span> DemoCacheLoader());

        <span style="color:#007f7f">//æ¨¡æ‹Ÿçº¿ç¨‹å¹¶å‘
</span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">new</span> Thread(() -&gt; {
            <span style="color:#007f7f">//éçº¿ç¨‹å®‰å…¨çš„æ—¶é—´æ ¼å¼åŒ–å·¥å…·
</span><span style="color:#007f7f"></span>            SimpleDateFormat simpleDateFormat = <span style="color:#fff;font-weight:bold">new</span> SimpleDateFormat(<span style="color:#0ff;font-weight:bold">&#34;HH:mm:ss&#34;</span>);
            <span style="color:#fff;font-weight:bold">try</span> {
                <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 0; i &lt; 10; i++) {
                    String value = cache.<span style="color:#007f7f">get</span>(1);
                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">getName</span>() + <span style="color:#0ff;font-weight:bold">&#34; &#34;</span> + simpleDateFormat.<span style="color:#007f7f">format</span>(<span style="color:#fff;font-weight:bold">new</span> Date()) + <span style="color:#0ff;font-weight:bold">&#34; &#34;</span> + value);
                    TimeUnit.<span style="color:#007f7f">SECONDS</span>.<span style="color:#007f7f">sleep</span>(3);
                }
            } <span style="color:#fff;font-weight:bold">catch</span> (Exception ignored) {
            }
        }).<span style="color:#007f7f">start</span>();

        <span style="color:#fff;font-weight:bold">new</span> Thread(() -&gt; {
            SimpleDateFormat simpleDateFormat = <span style="color:#fff;font-weight:bold">new</span> SimpleDateFormat(<span style="color:#0ff;font-weight:bold">&#34;HH:mm:ss&#34;</span>);
            <span style="color:#fff;font-weight:bold">try</span> {
                <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 0; i &lt; 10; i++) {
                    String value = cache.<span style="color:#007f7f">get</span>(1);
                    System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">getName</span>() + <span style="color:#0ff;font-weight:bold">&#34; &#34;</span> + simpleDateFormat.<span style="color:#007f7f">format</span>(<span style="color:#fff;font-weight:bold">new</span> Date()) + <span style="color:#0ff;font-weight:bold">&#34; &#34;</span> + value);
                    TimeUnit.<span style="color:#007f7f">SECONDS</span>.<span style="color:#007f7f">sleep</span>(5);
                }
            } <span style="color:#fff;font-weight:bold">catch</span> (Exception ignored) {
            }
        }).<span style="color:#007f7f">start</span>();
        <span style="color:#007f7f">//ç¼“å­˜çŠ¶æ€æŸ¥çœ‹
</span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(cache.<span style="color:#007f7f">stats</span>().<span style="color:#007f7f">toString</span>());

    }

    <span style="color:#007f7f">/**
</span><span style="color:#007f7f">     * éšæœºç¼“å­˜åŠ è½½,å®é™…ä½¿ç”¨æ—¶åº”å®ç°ä¸šåŠ¡çš„ç¼“å­˜åŠ è½½é€»è¾‘,ä¾‹å¦‚ä»æ•°æ®åº“è·å–æ•°æ®
</span><span style="color:#007f7f">     */</span>
    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">class</span> DemoCacheLoader <span style="color:#fff;font-weight:bold">extends</span> CacheLoader&lt;Integer, String&gt; {
        @Override
        <span style="color:#fff;font-weight:bold">public</span> String load(Integer key) <span style="color:#fff;font-weight:bold">throws</span> Exception {
            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">getName</span>() + <span style="color:#0ff;font-weight:bold">&#34; åŠ è½½æ•°æ®å¼€å§‹&#34;</span>);
            TimeUnit.<span style="color:#007f7f">SECONDS</span>.<span style="color:#007f7f">sleep</span>(8);
            Random random = <span style="color:#fff;font-weight:bold">new</span> Random();
            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">getName</span>() + <span style="color:#0ff;font-weight:bold">&#34; åŠ è½½æ•°æ®ç»“æŸ&#34;</span>);
            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;value:&#34;</span> + random.<span style="color:#007f7f">nextInt</span>(10000);
        }
    }
}
</code></pre></div><p>ä¸Šé¢ä¸€æ®µä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨Cacheåˆ›å»ºä¸€ä¸ªç¼“å­˜å¯¹è±¡å¹¶ä½¿ç”¨å®ƒã€‚</p>
<p>LoadingCacheæ˜¯Cacheçš„å­æ¥å£ï¼Œç›¸æ¯”è¾ƒäºCacheï¼Œå½“ä»LoadingCacheä¸­è¯»å–ä¸€ä¸ªæŒ‡å®škeyçš„è®°å½•æ—¶ï¼Œå¦‚æœè¯¥è®°å½•ä¸å­˜åœ¨ï¼Œåˆ™LoadingCacheå¯ä»¥è‡ªåŠ¨æ‰§è¡ŒåŠ è½½æ•°æ®åˆ°ç¼“å­˜çš„æ“ä½œã€‚</p>
<p>åœ¨è°ƒç”¨CacheBuilderçš„buildæ–¹æ³•æ—¶ï¼Œå¿…é¡»ä¼ é€’ä¸€ä¸ªCacheLoaderç±»å‹çš„å‚æ•°ï¼ŒCacheLoaderçš„loadæ–¹æ³•éœ€è¦æˆ‘ä»¬æä¾›å®ç°ã€‚å½“è°ƒç”¨LoadingCacheçš„getæ–¹æ³•æ—¶ï¼Œå¦‚æœç¼“å­˜ä¸å­˜åœ¨å¯¹åº”keyçš„è®°å½•ï¼Œåˆ™CacheLoaderä¸­çš„loadæ–¹æ³•ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ä»å¤–å­˜åŠ è½½æ•°æ®ï¼Œloadæ–¹æ³•çš„è¿”å›å€¼ä¼šä½œä¸ºkeyå¯¹åº”çš„valueå­˜å‚¨åˆ°LoadingCacheä¸­ï¼Œå¹¶ä»getæ–¹æ³•è¿”å›ã€‚</p>
<p>å½“ç„¶å¦‚æœä½ ä¸æƒ³æŒ‡å®šé‡å»ºç­–ç•¥ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨æ— å‚çš„build()æ–¹æ³•ï¼Œå®ƒå°†è¿”å›Cacheç±»å‹çš„æ„å»ºå¯¹è±¡ã€‚</p>
<p>CacheBuilder æ˜¯Guava æä¾›çš„ä¸€ä¸ªå¿«é€Ÿæ„å»ºç¼“å­˜å¯¹è±¡çš„å·¥å…·ç±»ã€‚CacheBuilderç±»é‡‡ç”¨builderè®¾è®¡æ¨¡å¼ï¼Œå®ƒçš„æ¯ä¸ªæ–¹æ³•éƒ½è¿”å›CacheBuilderæœ¬èº«ï¼Œç›´åˆ°buildæ–¹æ³•è¢«è°ƒç”¨ã€‚ è¯¥ç±»ä¸­æä¾›äº†å¾ˆå¤šçš„å‚æ•°è®¾ç½®é€‰é¡¹ï¼Œä½ å¯ä»¥è®¾ç½®cacheçš„é»˜è®¤å¤§å°ï¼Œå¹¶å‘æ•°ï¼Œå­˜æ´»æ—¶é—´ï¼Œè¿‡æœŸç­–ç•¥ç­‰ç­‰ã€‚</p>
<h4 id="å¯é€‰é…ç½®åˆ†æ">å¯é€‰é…ç½®åˆ†æ</h4>
<h5 id="ç¼“å­˜çš„å¹¶å‘çº§åˆ«">ç¼“å­˜çš„å¹¶å‘çº§åˆ«</h5>
<p>Guavaæä¾›äº†è®¾ç½®å¹¶å‘çº§åˆ«çš„apiï¼Œä½¿å¾—ç¼“å­˜æ”¯æŒå¹¶å‘çš„å†™å…¥å’Œè¯»å–ã€‚åŒ ConcurrentHashMap ç±»ä¼¼Guava cacheçš„å¹¶å‘ä¹Ÿæ˜¯é€šè¿‡åˆ†ç¦»é”å®ç°ã€‚åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå°†å¹¶å‘çº§åˆ«è®¾ç½®ä¸ºæœåŠ¡å™¨cpuæ ¸å¿ƒæ•°æ˜¯ä¸€ä¸ªæ¯”è¾ƒä¸é”™çš„é€‰æ‹©ã€‚</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">CacheBuilder.<span style="color:#007f7f">newBuilder</span>()
		<span style="color:#007f7f">// è®¾ç½®å¹¶å‘çº§åˆ«ä¸ºcpuæ ¸å¿ƒæ•°
</span><span style="color:#007f7f"></span>		.<span style="color:#007f7f">concurrencyLevel</span>(Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">availableProcessors</span>()) 
		.<span style="color:#007f7f">build</span>();
</code></pre></div><h5 id="ç¼“å­˜çš„åˆå§‹å®¹é‡è®¾ç½®">ç¼“å­˜çš„åˆå§‹å®¹é‡è®¾ç½®</h5>
<p>æˆ‘ä»¬åœ¨æ„å»ºç¼“å­˜æ—¶å¯ä»¥ä¸ºç¼“å­˜è®¾ç½®ä¸€ä¸ªåˆç†å¤§å°åˆå§‹å®¹é‡ï¼Œç”±äºGuavaçš„ç¼“å­˜ä½¿ç”¨äº†åˆ†ç¦»é”çš„æœºåˆ¶ï¼Œæ‰©å®¹çš„ä»£ä»·éå¸¸æ˜‚è´µã€‚æ‰€ä»¥åˆç†çš„åˆå§‹å®¹é‡èƒ½å¤Ÿå‡å°‘ç¼“å­˜å®¹å™¨çš„æ‰©å®¹æ¬¡æ•°ã€‚</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">CacheBuilder.<span style="color:#007f7f">newBuilder</span>()
		<span style="color:#007f7f">// è®¾ç½®åˆå§‹å®¹é‡ä¸º100
</span><span style="color:#007f7f"></span>		.<span style="color:#007f7f">initialCapacity</span>(100)
		.<span style="color:#007f7f">build</span>();
</code></pre></div><h5 id="è®¾ç½®æœ€å¤§å­˜å‚¨">è®¾ç½®æœ€å¤§å­˜å‚¨</h5>
<p>Guava Cacheå¯ä»¥åœ¨æ„å»ºç¼“å­˜å¯¹è±¡æ—¶æŒ‡å®šç¼“å­˜æ‰€èƒ½å¤Ÿå­˜å‚¨çš„æœ€å¤§è®°å½•æ•°é‡ã€‚å½“Cacheä¸­çš„è®°å½•æ•°é‡è¾¾åˆ°æœ€å¤§å€¼åå†è°ƒç”¨putæ–¹æ³•å‘å…¶ä¸­æ·»åŠ å¯¹è±¡ï¼ŒGuavaä¼šå…ˆä»å½“å‰ç¼“å­˜çš„å¯¹è±¡è®°å½•ä¸­é€‰æ‹©ä¸€æ¡åˆ é™¤æ‰ï¼Œè…¾å‡ºç©ºé—´åå†å°†æ–°çš„å¯¹è±¡å­˜å‚¨åˆ°Cacheä¸­ã€‚</p>
<ol>
<li><strong>åŸºäºå®¹é‡çš„æ¸…é™¤(size-based eviction):</strong> é€šè¿‡CacheBuilder.maximumSize(long)æ–¹æ³•å¯ä»¥è®¾ç½®Cacheçš„æœ€å¤§å®¹é‡æ•°ï¼Œå½“ç¼“å­˜æ•°é‡è¾¾åˆ°æˆ–æ¥è¿‘è¯¥æœ€å¤§å€¼æ—¶ï¼ŒCacheå°†æ¸…é™¤æ‰é‚£äº›æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç¼“å­˜;</li>
<li><strong>åŸºäºæƒé‡çš„æ¸…é™¤:</strong> ä½¿ç”¨CacheBuilder.weigher(Weigher)æŒ‡å®šä¸€ä¸ªæƒé‡å‡½æ•°ï¼Œå¹¶ä¸”ç”¨CacheBuilder.maximumWeight(long)æŒ‡å®šæœ€å¤§æ€»é‡ã€‚æ¯”å¦‚æ¯ä¸€é¡¹ç¼“å­˜æ‰€å æ®çš„å†…å­˜ç©ºé—´å¤§å°éƒ½ä¸ä¸€æ ·ï¼Œå¯ä»¥çœ‹ä½œå®ƒä»¬æœ‰ä¸åŒçš„â€œæƒé‡â€ï¼ˆweightsï¼‰ã€‚</li>
</ol>
<h5 id="ç¼“å­˜æ¸…é™¤ç­–ç•¥">ç¼“å­˜æ¸…é™¤ç­–ç•¥</h5>
<h6 id="1-åŸºäºå­˜æ´»æ—¶é—´çš„æ¸…é™¤">1. åŸºäºå­˜æ´»æ—¶é—´çš„æ¸…é™¤</h6>
<ul>
<li>expireAfterWrite å†™ç¼“å­˜åå¤šä¹…è¿‡æœŸ</li>
<li>expireAfterAccess è¯»å†™ç¼“å­˜åå¤šä¹…è¿‡æœŸ</li>
<li>refreshAfterWrite å†™å…¥æ•°æ®åå¤šä¹…è¿‡æœŸ,åªé˜»å¡å½“å‰æ•°æ®åŠ è½½çº¿ç¨‹,å…¶ä»–çº¿ç¨‹è¿”å›æ—§å€¼</li>
</ul>
<p>è¿™å‡ ä¸ªç­–ç•¥æ—¶é—´å¯ä»¥å•ç‹¬è®¾ç½®,ä¹Ÿå¯ä»¥ç»„åˆé…ç½®ã€‚</p>
<h6 id="2-ä¸Šé¢æåˆ°çš„åŸºäºå®¹é‡çš„æ¸…é™¤">2. ä¸Šé¢æåˆ°çš„åŸºäºå®¹é‡çš„æ¸…é™¤</h6>
<h6 id="3-æ˜¾å¼æ¸…é™¤">3. æ˜¾å¼æ¸…é™¤</h6>
<p>ä»»ä½•æ—¶å€™ï¼Œä½ éƒ½å¯ä»¥æ˜¾å¼åœ°æ¸…é™¤ç¼“å­˜é¡¹ï¼Œè€Œä¸æ˜¯ç­‰åˆ°å®ƒè¢«å›æ”¶ï¼ŒCacheæ¥å£æä¾›äº†å¦‚ä¸‹APIï¼š</p>
<ol>
<li>ä¸ªåˆ«æ¸…é™¤ï¼šCache.invalidate(key)</li>
<li>æ‰¹é‡æ¸…é™¤ï¼šCache.invalidateAll(keys)</li>
<li>æ¸…é™¤æ‰€æœ‰ç¼“å­˜é¡¹ï¼šCache.invalidateAll()</li>
</ol>
<h6 id="4-åŸºäºå¼•ç”¨çš„æ¸…é™¤reference-based-eviction">4. åŸºäºå¼•ç”¨çš„æ¸…é™¤ï¼ˆReference-based Evictionï¼‰</h6>
<p>åœ¨æ„å»ºCacheå®ä¾‹è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡è®¾ç½®ä½¿ç”¨å¼±å¼•ç”¨çš„é”®ã€æˆ–å¼±å¼•ç”¨çš„å€¼ã€æˆ–è½¯å¼•ç”¨çš„å€¼ï¼Œä»è€Œä½¿JVMåœ¨GCæ—¶é¡ºå¸¦å®ç°ç¼“å­˜çš„æ¸…é™¤ï¼Œä¸è¿‡ä¸€èˆ¬ä¸è½»æ˜“ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ã€‚</p>
<ul>
<li>CacheBuilder.weakKeys()ï¼šä½¿ç”¨å¼±å¼•ç”¨å­˜å‚¨é”®ã€‚å½“é”®æ²¡æœ‰å…¶å®ƒï¼ˆå¼ºæˆ–è½¯ï¼‰å¼•ç”¨æ—¶ï¼Œç¼“å­˜é¡¹å¯ä»¥è¢«åƒåœ¾å›æ”¶ã€‚å› ä¸ºåƒåœ¾å›æ”¶ä»…ä¾èµ–æ’ç­‰å¼ï¼Œä½¿ç”¨å¼±å¼•ç”¨é”®çš„ç¼“å­˜ç”¨è€Œä¸æ˜¯equalsæ¯”è¾ƒé”®ã€‚</li>
<li>CacheBuilder.weakValues()ï¼šä½¿ç”¨å¼±å¼•ç”¨å­˜å‚¨å€¼ã€‚å½“å€¼æ²¡æœ‰å…¶å®ƒï¼ˆå¼ºæˆ–è½¯ï¼‰å¼•ç”¨æ—¶ï¼Œç¼“å­˜é¡¹å¯ä»¥è¢«åƒåœ¾å›æ”¶ã€‚å› ä¸ºåƒåœ¾å›æ”¶ä»…ä¾èµ–æ’ç­‰å¼ï¼Œä½¿ç”¨å¼±å¼•ç”¨å€¼çš„ç¼“å­˜ç”¨è€Œä¸æ˜¯equalsæ¯”è¾ƒå€¼ã€‚</li>
<li>CacheBuilder.softValues()ï¼šä½¿ç”¨è½¯å¼•ç”¨å­˜å‚¨å€¼ã€‚è½¯å¼•ç”¨åªæœ‰åœ¨å“åº”å†…å­˜éœ€è¦æ—¶ï¼Œæ‰æŒ‰ç…§å…¨å±€æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„é¡ºåºå›æ”¶ã€‚è€ƒè™‘åˆ°ä½¿ç”¨è½¯å¼•ç”¨çš„æ€§èƒ½å½±å“ï¼Œæˆ‘ä»¬é€šå¸¸å»ºè®®ä½¿ç”¨æ›´æœ‰æ€§èƒ½é¢„æµ‹æ€§çš„ç¼“å­˜å¤§å°é™å®šï¼ˆè§ä¸Šæ–‡ï¼ŒåŸºäºå®¹é‡å›æ”¶ï¼‰ã€‚ä½¿ç”¨è½¯å¼•ç”¨å€¼çš„ç¼“å­˜åŒæ ·ç”¨==è€Œä¸æ˜¯equalsæ¯”è¾ƒå€¼ã€‚</li>
</ul>
<h5 id="æ¸…ç†ä»€ä¹ˆæ—¶å€™å‘ç”Ÿ">æ¸…ç†ä»€ä¹ˆæ—¶å€™å‘ç”Ÿ</h5>
<p>ä¹Ÿè®¸è¿™ä¸ªé—®é¢˜æœ‰ç‚¹å¥‡æ€ªï¼Œå¦‚æœè®¾ç½®çš„å­˜æ´»æ—¶é—´ä¸ºä¸€åˆ†é’Ÿï¼Œéš¾é“ä¸æ˜¯ä¸€åˆ†é’Ÿåè¿™ä¸ªkeyå°±ä¼šç«‹å³æ¸…é™¤æ‰å—ï¼Ÿæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹å¦‚æœè¦å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œé‚£Cacheä¸­å°±å¿…é¡»å­˜åœ¨çº¿ç¨‹æ¥è¿›è¡Œå‘¨æœŸæ€§åœ°æ£€æŸ¥ã€æ¸…é™¤ç­‰å·¥ä½œï¼Œå¾ˆå¤šcacheå¦‚redisã€ehcacheéƒ½æ˜¯è¿™æ ·å®ç°çš„ã€‚</p>
<p>ä½¿ç”¨CacheBuilderæ„å»ºçš„ç¼“å­˜ä¸ä¼šâ€è‡ªåŠ¨â€æ‰§è¡Œæ¸…ç†å’Œå›æ”¶å·¥ä½œï¼Œä¹Ÿä¸ä¼šåœ¨æŸä¸ªç¼“å­˜é¡¹è¿‡æœŸåé©¬ä¸Šæ¸…ç†ï¼Œä¹Ÿæ²¡æœ‰è¯¸å¦‚æ­¤ç±»çš„æ¸…ç†æœºåˆ¶ã€‚ç›¸åï¼Œå®ƒä¼šåœ¨å†™æ“ä½œæ—¶é¡ºå¸¦åšå°‘é‡çš„ç»´æŠ¤å·¥ä½œï¼Œæˆ–è€…å¶å°”åœ¨è¯»æ“ä½œæ—¶åšâ€”â€”å¦‚æœå†™æ“ä½œå®åœ¨å¤ªå°‘çš„è¯ã€‚</p>
<p>è¿™æ ·åšçš„åŸå› åœ¨äºï¼šå¦‚æœè¦è‡ªåŠ¨åœ°æŒç»­æ¸…ç†ç¼“å­˜ï¼Œå°±å¿…é¡»æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹ä¼šå’Œç”¨æˆ·æ“ä½œç«äº‰å…±äº«é”ã€‚æ­¤å¤–ï¼ŒæŸäº›ç¯å¢ƒä¸‹çº¿ç¨‹åˆ›å»ºå¯èƒ½å—é™åˆ¶ï¼Œè¿™æ ·CacheBuilderå°±ä¸å¯ç”¨äº†ã€‚å‚è€ƒå¦‚ä¸‹ç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">package</span> com.rickiyang.learn.cache;

<span style="color:#fff;font-weight:bold">import</span> com.google.common.cache.Cache;
<span style="color:#fff;font-weight:bold">import</span> com.google.common.cache.CacheBuilder;

<span style="color:#fff;font-weight:bold">import</span> java.text.SimpleDateFormat;
<span style="color:#fff;font-weight:bold">import</span> java.util.Date;
<span style="color:#fff;font-weight:bold">import</span> java.util.concurrent.TimeUnit;

<span style="color:#007f7f">/**
</span><span style="color:#007f7f"> * @author: rickiyang
</span><span style="color:#007f7f"> * @date: 2019/6/12
</span><span style="color:#007f7f"> * @description:
</span><span style="color:#007f7f"> */</span>
<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> GuavaCacheService {


    <span style="color:#fff;font-weight:bold">static</span> Cache&lt;Integer, String&gt; cache = CacheBuilder.<span style="color:#007f7f">newBuilder</span>()
            .<span style="color:#007f7f">expireAfterWrite</span>(5, TimeUnit.<span style="color:#007f7f">SECONDS</span>)
            .<span style="color:#007f7f">build</span>();

    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
        <span style="color:#fff;font-weight:bold">new</span> Thread(() -&gt; {
            <span style="color:#fff;font-weight:bold">while</span> (<span style="color:#fff;font-weight:bold">true</span>) {
                SimpleDateFormat sdf = <span style="color:#fff;font-weight:bold">new</span> SimpleDateFormat(<span style="color:#0ff;font-weight:bold">&#34;HH:mm:ss&#34;</span>);
                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(sdf.<span style="color:#007f7f">format</span>(<span style="color:#fff;font-weight:bold">new</span> Date()) + <span style="color:#0ff;font-weight:bold">&#34; size: &#34;</span> + cache.<span style="color:#007f7f">size</span>());
                <span style="color:#fff;font-weight:bold">try</span> {
                    Thread.<span style="color:#007f7f">sleep</span>(2000);
                } <span style="color:#fff;font-weight:bold">catch</span> (InterruptedException e) {

                }
            }
        }).<span style="color:#007f7f">start</span>();
        SimpleDateFormat sdf = <span style="color:#fff;font-weight:bold">new</span> SimpleDateFormat(<span style="color:#0ff;font-weight:bold">&#34;HH:mm:ss&#34;</span>);
        cache.<span style="color:#007f7f">put</span>(1, <span style="color:#0ff;font-weight:bold">&#34;a&#34;</span>);
        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;å†™å…¥ key:1 ,value:&#34;</span> + cache.<span style="color:#007f7f">getIfPresent</span>(1));
        Thread.<span style="color:#007f7f">sleep</span>(10000);
        cache.<span style="color:#007f7f">put</span>(2, <span style="color:#0ff;font-weight:bold">&#34;b&#34;</span>);
        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;å†™å…¥ key:2 ,value:&#34;</span> + cache.<span style="color:#007f7f">getIfPresent</span>(2));
        Thread.<span style="color:#007f7f">sleep</span>(10000);
        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(sdf.<span style="color:#007f7f">format</span>(<span style="color:#fff;font-weight:bold">new</span> Date())
                + <span style="color:#0ff;font-weight:bold">&#34; sleep 10s , key:1 ,value:&#34;</span> + cache.<span style="color:#007f7f">getIfPresent</span>(1));
        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(sdf.<span style="color:#007f7f">format</span>(<span style="color:#fff;font-weight:bold">new</span> Date())
                + <span style="color:#0ff;font-weight:bold">&#34; sleep 10s, key:2 ,value:&#34;</span> + cache.<span style="color:#007f7f">getIfPresent</span>(2));
    }
}

éƒ¨åˆ†è¾“å‡ºç»“æœ<span style="color:#f00">ï¼š</span>
23:57:36 size: 0
å†™å…¥ key:1 ,value:a
23:57:38 size: 1
23:57:40 size: 1
23:57:42 size: 1
23:57:44 size: 1
23:57:46 size: 1
å†™å…¥ key:2 ,value:b
23:57:48 size: 1
23:57:50 size: 1
23:57:52 size: 1
23:57:54 size: 1
23:57:56 size: 1
23:57:56 sleep 10s , key:1 ,value:<span style="color:#fff;font-weight:bold">null</span>
23:57:56 sleep 10s, key:2 ,value:<span style="color:#fff;font-weight:bold">null</span>
23:57:58 size: 0
23:58:00 size: 0
23:58:02 size: 0
    ...
    ...
</code></pre></div><p>ä¸Šé¢ç¨‹åºè®¾ç½®äº†ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸º5Sï¼Œæ¯æ‰“å°ä¸€æ¬¡å½“å‰çš„sizeéœ€è¦2Sï¼Œæ‰“å°äº†5æ¬¡sizeä¹‹åå†™å…¥key 2ï¼Œæ­¤æ—¶çš„sizeä¸º1ï¼Œè¯´æ˜åœ¨è¿™ä¸ªæ—¶å€™æ‰æŠŠç¬¬ä¸€æ¬¡åº”è¯¥è¿‡æœŸçš„key 1ç»™åˆ é™¤ã€‚</p>
<p><strong>ç»™ç§»é™¤æ“ä½œæ·»åŠ ä¸€ä¸ªç›‘å¬å™¨ï¼š</strong></p>
<p>å¯ä»¥ä¸ºCacheå¯¹è±¡æ·»åŠ ä¸€ä¸ªç§»é™¤ç›‘å¬å™¨ï¼Œè¿™æ ·å½“æœ‰è®°å½•è¢«åˆ é™¤æ—¶å¯ä»¥æ„ŸçŸ¥åˆ°è¿™ä¸ªäº‹ä»¶ã€‚</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">RemovalListener&lt;String, String&gt; listener = notification -&gt; System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;[&#34;</span> + notification.<span style="color:#007f7f">getKey</span>() + <span style="color:#0ff;font-weight:bold">&#34;:&#34;</span> + notification.<span style="color:#007f7f">getValue</span>() + <span style="color:#0ff;font-weight:bold">&#34;] is removed!&#34;</span>);
        Cache&lt;String,String&gt; cache = CacheBuilder.<span style="color:#007f7f">newBuilder</span>()
                .<span style="color:#007f7f">maximumSize</span>(5)
                .<span style="color:#007f7f">removalListener</span>(listener)
                .<span style="color:#007f7f">build</span>();
</code></pre></div><p><strong>ä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼š</strong></p>
<p><strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œç›‘å¬å™¨æ–¹æ³•æ˜¯åœ¨ç§»é™¤ç¼“å­˜æ—¶åŒæ­¥è°ƒç”¨çš„ã€‚å› ä¸ºç¼“å­˜çš„ç»´æŠ¤å’Œè¯·æ±‚å“åº”é€šå¸¸æ˜¯åŒæ—¶è¿›è¡Œçš„ï¼Œä»£ä»·é«˜æ˜‚çš„ç›‘å¬å™¨æ–¹æ³•åœ¨åŒæ­¥æ¨¡å¼ä¸‹ä¼šæ‹–æ…¢æ­£å¸¸çš„ç¼“å­˜è¯·æ±‚ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨<code>RemovalListeners.asynchronous(RemovalListener, Executor)</code>æŠŠç›‘å¬å™¨è£…é¥°ä¸ºå¼‚æ­¥æ“ä½œã€‚</strong></p>
<h5 id="è‡ªåŠ¨åŠ è½½">è‡ªåŠ¨åŠ è½½</h5>
<p>ä¸Šé¢æˆ‘ä»¬è¯´è¿‡ä½¿ç”¨getæ–¹æ³•çš„æ—¶å€™å¦‚æœkeyä¸å­˜åœ¨ä½ å¯ä»¥ä½¿ç”¨æŒ‡å®šæ–¹æ³•å»åŠ è½½è¿™ä¸ªkeyã€‚åœ¨Cacheæ„å»ºçš„æ—¶å€™é€šè¿‡æŒ‡å®šCacheLoderçš„æ–¹å¼ã€‚å¦‚æœä½ æ²¡æœ‰æŒ‡å®šï¼Œä½ ä¹Ÿå¯ä»¥åœ¨getçš„æ—¶å€™æ˜¾å¼çš„è°ƒç”¨callæ–¹æ³•æ¥è®¾ç½®keyä¸å­˜åœ¨çš„è¡¥æ•‘ç­–ç•¥ã€‚</p>
<p>Cacheçš„getæ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦ä»Cacheä¸­è·å–è®°å½•çš„keyï¼Œç¬¬äºŒä¸ªè®°å½•æ˜¯ä¸€ä¸ªCallableå¯¹è±¡ã€‚</p>
<p>å½“ç¼“å­˜ä¸­å·²ç»å­˜åœ¨keyå¯¹åº”çš„è®°å½•æ—¶ï¼Œgetæ–¹æ³•ç›´æ¥è¿”å›keyå¯¹åº”çš„è®°å½•ã€‚å¦‚æœç¼“å­˜ä¸­ä¸åŒ…å«keyå¯¹åº”çš„è®°å½•ï¼ŒGuavaä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒCallableå¯¹è±¡ä¸­çš„callæ–¹æ³•ï¼Œcallæ–¹æ³•çš„è¿”å›å€¼ä¼šä½œä¸ºkeyå¯¹åº”çš„å€¼è¢«å­˜å‚¨åˆ°ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”è¢«getæ–¹æ³•è¿”å›ã€‚</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">package</span> com.rickiyang.learn.cache;

<span style="color:#fff;font-weight:bold">import</span> com.google.common.cache.Cache;
<span style="color:#fff;font-weight:bold">import</span> com.google.common.cache.CacheBuilder;

<span style="color:#fff;font-weight:bold">import</span> java.util.concurrent.Callable;
<span style="color:#fff;font-weight:bold">import</span> java.util.concurrent.ExecutionException;

<span style="color:#007f7f">/**
</span><span style="color:#007f7f"> * @author: rickiyang
</span><span style="color:#007f7f"> * @date: 2019/6/12
</span><span style="color:#007f7f"> * @description:
</span><span style="color:#007f7f"> */</span>
<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> GuavaCacheService {


    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> Cache&lt;String, String&gt; cache = CacheBuilder.<span style="color:#007f7f">newBuilder</span>()
            .<span style="color:#007f7f">maximumSize</span>(3)
            .<span style="color:#007f7f">build</span>();

    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {

        <span style="color:#fff;font-weight:bold">new</span> Thread(() -&gt; {
            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;thread1&#34;</span>);
            <span style="color:#fff;font-weight:bold">try</span> {
                String value = cache.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;key&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> Callable&lt;String&gt;() {
                    <span style="color:#fff;font-weight:bold">public</span> String call() <span style="color:#fff;font-weight:bold">throws</span> Exception {
                        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;thread1&#34;</span>); <span style="color:#007f7f">//åŠ è½½æ•°æ®çº¿ç¨‹æ‰§è¡Œæ ‡å¿—
</span><span style="color:#007f7f"></span>                        Thread.<span style="color:#007f7f">sleep</span>(1000); <span style="color:#007f7f">//æ¨¡æ‹ŸåŠ è½½æ—¶é—´
</span><span style="color:#007f7f"></span>                        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;thread1&#34;</span>;
                    }
                });
                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;thread1 &#34;</span> + value);
            } <span style="color:#fff;font-weight:bold">catch</span> (ExecutionException e) {
                e.<span style="color:#007f7f">printStackTrace</span>();
            }
        }).<span style="color:#007f7f">start</span>();
        <span style="color:#fff;font-weight:bold">new</span> Thread(() -&gt; {
            System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;thread2&#34;</span>);
            <span style="color:#fff;font-weight:bold">try</span> {
                String value = cache.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;key&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> Callable&lt;String&gt;() {
                    <span style="color:#fff;font-weight:bold">public</span> String call() <span style="color:#fff;font-weight:bold">throws</span> Exception {
                        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;thread2&#34;</span>); <span style="color:#007f7f">//åŠ è½½æ•°æ®çº¿ç¨‹æ‰§è¡Œæ ‡å¿—
</span><span style="color:#007f7f"></span>                        Thread.<span style="color:#007f7f">sleep</span>(1000); <span style="color:#007f7f">//æ¨¡æ‹ŸåŠ è½½æ—¶é—´
</span><span style="color:#007f7f"></span>                        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;thread2&#34;</span>;
                    }
                });
                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;thread2 &#34;</span> + value);
            } <span style="color:#fff;font-weight:bold">catch</span> (ExecutionException e) {
                e.<span style="color:#007f7f">printStackTrace</span>();
            }
        }).<span style="color:#007f7f">start</span>();
    }

}

è¾“å‡ºç»“æœä¸º<span style="color:#f00">ï¼š</span>
thread1
thread2
thread2
thread1 thread2
thread2 thread2
</code></pre></div><p>å¯ä»¥çœ‹åˆ°è¾“å‡ºç»“æœï¼šä¸¤ä¸ªçº¿ç¨‹éƒ½å¯åŠ¨ï¼Œè¾“å‡ºthread1ï¼Œthread2ï¼Œæ¥ç€åˆè¾“å‡ºäº†thread2ï¼Œè¯´æ˜è¿›å…¥äº†thread2çš„callæ–¹æ³•äº†ï¼Œæ­¤æ—¶thread1æ­£åœ¨é˜»å¡ï¼Œç­‰å¾…keyè¢«è®¾ç½®ã€‚ç„¶åthread1 å¾—åˆ°äº†valueæ˜¯thread2ï¼Œthread2çš„ç»“æœè‡ªç„¶ä¹Ÿæ˜¯thread2ã€‚</p>
<p>è¿™æ®µä»£ç ä¸­æœ‰ä¸¤ä¸ªçº¿ç¨‹å…±äº«åŒä¸€ä¸ªCacheå¯¹è±¡ï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨getæ–¹æ³•è·å–åŒä¸€ä¸ªkeyå¯¹åº”çš„è®°å½•ã€‚ç”±äºkeyå¯¹åº”çš„è®°å½•ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨getæ–¹æ³•å¤„é˜»å¡ã€‚æ­¤å¤„åœ¨callæ–¹æ³•ä¸­è°ƒç”¨Thread.sleep(1000)æ¨¡æ‹Ÿç¨‹åºä»å¤–å­˜åŠ è½½æ•°æ®çš„æ—¶é—´æ¶ˆè€—ã€‚</p>
<p>ä»ç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶æ˜¯ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨getæ–¹æ³•ï¼Œä½†åªæœ‰ä¸€ä¸ªgetæ–¹æ³•ä¸­çš„Callableä¼šè¢«æ‰§è¡Œ(æ²¡æœ‰æ‰“å°å‡ºload2)ã€‚Guavaå¯ä»¥ä¿è¯å½“æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®Cacheä¸­çš„ä¸€ä¸ªkeyæ—¶ï¼Œå¦‚æœkeyå¯¹åº”çš„è®°å½•ä¸å­˜åœ¨ï¼ŒGuavaåªä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œgetæ–¹æ³•ä¸­Callableå‚æ•°å¯¹åº”çš„ä»»åŠ¡åŠ è½½æ•°æ®å­˜åˆ°ç¼“å­˜ã€‚å½“åŠ è½½å®Œæ•°æ®åï¼Œä»»ä½•çº¿ç¨‹ä¸­çš„getæ–¹æ³•éƒ½ä¼šè·å–åˆ°keyå¯¹åº”çš„å€¼ã€‚</p>
<h5 id="ç»Ÿè®¡ä¿¡æ¯">ç»Ÿè®¡ä¿¡æ¯</h5>
<p>å¯ä»¥å¯¹Cacheçš„å‘½ä¸­ç‡ã€åŠ è½½æ•°æ®æ—¶é—´ç­‰ä¿¡æ¯è¿›è¡Œç»Ÿè®¡ã€‚åœ¨æ„å»ºCacheå¯¹è±¡æ—¶ï¼Œå¯ä»¥é€šè¿‡CacheBuilderçš„recordStatsæ–¹æ³•å¼€å¯ç»Ÿè®¡ä¿¡æ¯çš„å¼€å…³ã€‚å¼€å…³å¼€å¯åCacheä¼šè‡ªåŠ¨å¯¹ç¼“å­˜çš„å„ç§æ“ä½œè¿›è¡Œç»Ÿè®¡ï¼Œè°ƒç”¨Cacheçš„statsæ–¹æ³•å¯ä»¥æŸ¥çœ‹ç»Ÿè®¡åçš„ä¿¡æ¯ã€‚</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#fff;font-weight:bold">package</span> com.rickiyang.learn.cache;

<span style="color:#fff;font-weight:bold">import</span> com.google.common.cache.Cache;
<span style="color:#fff;font-weight:bold">import</span> com.google.common.cache.CacheBuilder;

<span style="color:#007f7f">/**
</span><span style="color:#007f7f"> * @author: rickiyang
</span><span style="color:#007f7f"> * @date: 2019/6/12
</span><span style="color:#007f7f"> * @description:
</span><span style="color:#007f7f"> */</span>
<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> GuavaCacheService {


    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
        Cache&lt;String, String&gt; cache = CacheBuilder.<span style="color:#007f7f">newBuilder</span>()
                .<span style="color:#007f7f">maximumSize</span>(3)
                .<span style="color:#007f7f">recordStats</span>() <span style="color:#007f7f">//å¼€å¯ç»Ÿè®¡ä¿¡æ¯å¼€å…³
</span><span style="color:#007f7f"></span>                .<span style="color:#007f7f">build</span>();
        cache.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;1&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;v1&#34;</span>);
        cache.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;2&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;v2&#34;</span>);
        cache.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;3&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;v3&#34;</span>);
        cache.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;4&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;v4&#34;</span>);

        cache.<span style="color:#007f7f">getIfPresent</span>(<span style="color:#0ff;font-weight:bold">&#34;1&#34;</span>);
        cache.<span style="color:#007f7f">getIfPresent</span>(<span style="color:#0ff;font-weight:bold">&#34;2&#34;</span>);
        cache.<span style="color:#007f7f">getIfPresent</span>(<span style="color:#0ff;font-weight:bold">&#34;3&#34;</span>);
        cache.<span style="color:#007f7f">getIfPresent</span>(<span style="color:#0ff;font-weight:bold">&#34;4&#34;</span>);
        cache.<span style="color:#007f7f">getIfPresent</span>(<span style="color:#0ff;font-weight:bold">&#34;5&#34;</span>);
        cache.<span style="color:#007f7f">getIfPresent</span>(<span style="color:#0ff;font-weight:bold">&#34;6&#34;</span>);

        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(cache.<span style="color:#007f7f">stats</span>()); <span style="color:#007f7f">//è·å–ç»Ÿè®¡ä¿¡æ¯
</span><span style="color:#007f7f"></span>    }

}

è¾“å‡º<span style="color:#f00">ï¼š</span>
CacheStats{hitCount=3, missCount=3, loadSuccessCount=0, loadExceptionCount=0, totalLoadTime=0, evictionCount=1}
</code></pre></div><p>ï¼ˆå…¨æ–‡å®Œï¼‰</p>
<p><strong>è‘—ä½œæƒå½’åŸä½œè€…æ‰€æœ‰ï¼Œ<a href="https://www.cnblogs.com/rickiyang/p/11074159.html#299371220">åŸæ–‡é“¾æ¥</a>ã€‚</strong></p>

  </article>
</section>


    </div>

    <footer class="footer">
  <div class="footer-taxonomy">
    <div style="margin-bottom: 10px;">
      <a href="https://wiki.bmpi.dev/" rel="nofollow">Wiki</a>
      âš”ï¸
      <a href="https://talk.bmpi.dev/" rel="nofollow">Talk</a>
      âš”ï¸
      <a href="https://www.notion.so/mdw/e0ed086e701a4d0aaa4839d2c7aa62ea" rel="nofollow">Portfolio</a>
      âš”ï¸
      <a href="https://money.i365.tech/">Money</a>
    </div>
    <div>
      <a href= /affiliate >Affiliate</a>
      âš¡ï¸
      <a href= /tool >Tool</a>
      âš¡ï¸
      <a href= /link >Link</a>
    </div>
  </div>
  <div class="footer-taxonomy">
    <a href= /tags style="color: #B36D61;">Tags</a>
    ğŸ‘ˆ
    <a href= /categories style="color: #FF8C31;">Categories</a>
    ğŸ‘‰
    <a href= /series style="color: #519A73;">Series</a>
  </div>
  <section class="container">
    
     Â© 2019 - 2020
    
    
  </section>
</footer>

  </main>

  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-154678195-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-154678195-1');
  </script>
  

  
  <script>(function(w,d, s, id) {w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('init','BHuwaXciWicBjh6HQS2tfudv6IYQD11K9u1NUj7nuaEV9NoDT7ns9JjgqyYTflUv-m3TlD7ELY84AHMfgmPXNgU');</script>
  

</body>

</html>
